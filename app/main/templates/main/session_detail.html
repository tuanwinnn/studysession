{% extends "base.html" %}

{% block title %}{{ session.title }} - Study Sessions{% endblock %}

{% block content %}
<div class="session-detail">
    <!-- Session title -->
    <h1>{{ session.title }}</h1>
    
    <!-- Core session info (date, time, location, etc.) -->
    <div class="session-info">
        <p><strong>Date:</strong> {{ session.date.strftime('%B %d, %Y') }}</p>
        <p><strong>Time:</strong> {{ session.time }}</p>
        <p><strong>Location:</strong> {{ session.location }}</p>
        {% if session.topic %}
            <p><strong>Topic:</strong> {{ session.topic }}</p>
        {% endif %}
        <p><strong>Created by:</strong> {{ session.creator.username }}</p>
        <p><strong>Created on:</strong> {{ session.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
        
        {% if session.is_recurring %}
            <p><strong>Recurrence:</strong> This session repeats {{ session.recurrence_interval }}</p>
        {% endif %}
        
        {% if session.parent_id %}
            <p><strong>Series:</strong> This session is part of a recurring series</p>
        {% endif %}
        
        {% if session.is_past() %}
            <!-- Visual warning when the session date is in the past -->
            <p class="past-session-note" style="color: #e74c3c; font-weight: bold;">
                ‚ö†Ô∏è This session has already occurred.
            </p>
        {% endif %}
    </div>
    
    <!-- Location Suggestion (optional helper text for where to meet) -->
    {% if location_suggestion %}
    <div class="location-suggestion" style="background-color: #e8f5e9; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
        <strong>üí° Location Suggestion:</strong> {{ location_suggestion }}
    </div>
    {% endif %}
    
    <!-- Participants list -->
    <div class="participants-section">
        <h2>Participants ({{ session.get_participant_count() }})</h2>
        <ul class="participant-list">
            {% for member in session.members %}
                <li>
                    {{ member.username }}
                    {% if member.id == session.creator_id %}
                        <!-- Highlight the creator in the participant list -->
                        <span class="badge">Creator</span>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
        <h2>Comments ({{ session.comments|length }})</h2>
        
        <div class="comments">
            {% if session.comments %}
                <!-- Show comments sorted by timestamp (oldest -> newest) -->
                {% for comment in session.comments|sort(attribute='timestamp') %}
                    <div class="comment">
                        <strong>{{ comment.user.username }}</strong>
                        <small>{{ comment.timestamp.strftime('%b %d, %I:%M %p') }}</small>
                        <p>{{ comment.content }}</p>
                    </div>
                {% endfor %}
            {% else %}
                <!-- Empty state when there are no comments yet -->
                <p>No comments yet. Be the first to comment!</p>
            {% endif %}
        </div>
        
        <!-- Comment Form (only visible to session members) -->
        {% if is_member %}
        <div class="comment-form">
            <h3>Add a Comment</h3>
            <form method="POST" action="{{ url_for('main.add_comment', session_id=session.id) }}">
                {{ comment_form.hidden_tag() }}
                <div class="form-group">
                    {{ comment_form.content(
                        class="form-control",
                        rows="3",
                        placeholder="Share your thoughts, questions, or coordination details..."
                    ) }}
                    {% if comment_form.content.errors %}
                        <!-- Validation errors for the comment field -->
                        <div class="error">
                            {% for error in comment_form.content.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                {{ comment_form.submit(class="btn btn-secondary") }}
            </form>
        </div>
        {% else %}
        <!-- Non-members cannot post comments -->
        <p style="color: #666; font-style: italic;">Join this session to leave a comment.</p>
        {% endif %}
    </div>
    
    <!-- Action buttons for navigation and session actions -->
    <div class="button-group">
        <!-- Always available: go back to the sessions list -->
        <a href="{{ url_for('main.view_sessions') }}" class="btn btn-secondary">Back to Sessions</a>
        
        {% if is_creator %}
            <!-- Creator can edit or delete the session -->
            <a href="{{ url_for('main.edit_session', session_id=session.id) }}" class="btn">Edit Session</a>
            <form
                action="{{ url_for('main.delete_session', session_id=session.id) }}"
                method="POST"
                style="display:inline;"
                onsubmit="return confirm('Are you sure you want to delete this session?');"
            >
                <button class="btn btn-danger">Delete Session</button>
            </form>
        {% elif is_member %}
            <!-- Non-creator member can leave the session -->
            <form
                action="{{ url_for('main.leave_session', session_id=session.id) }}"
                method="POST"
                style="display:inline;"
            >
                <button class="btn leave-btn">Leave Session</button>
            </form>
        {% else %}
            <!-- User is neither creator nor member -->
            {% if not session.is_past() %}
                <!-- Allow joining only if the session is upcoming -->
                <form
                    action="{{ url_for('main.join_session', session_id=session.id) }}"
                    method="POST"
                    style="display:inline;"
                >
                    <button class="btn join-btn">Join Session</button>
                </form>
            {% else %}
                <!-- Past sessions cannot be joined -->
                <span class="past-session">This session has already occurred</span>
            {% endif %}
        {% endif %}
    </div>
</div>
{% endblock %}
